<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Submissions</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

  <style>
    /* --- 1. LOGIN SCREEN STYLES (NEW) --- */
    #loginOverlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #0f172a; /* Dark background */
        z-index: 9999;
        display: flex; justify-content: center; align-items: center;
        transition: opacity 0.5s ease;
    }
    
    .login-card {
        background: white; padding: 2.5rem; border-radius: 16px; width: 100%; max-width: 400px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    /* --- 2. MAIN CONTENT BLUR EFFECT --- */
    #dashboardContent {
        filter: blur(10px); /* Blurs the site until logged in */
        opacity: 0.3;
        pointer-events: none; /* Prevents clicking */
        transition: all 0.5s ease;
    }

    /* When class 'authenticated' is added to body: */
    body.authenticated #dashboardContent { filter: none; opacity: 1; pointer-events: all; }
    body.authenticated #loginOverlay { opacity: 0; pointer-events: none; }


    /* --- 3. YOUR ORIGINAL DESIGN STYLES (UNCHANGED) --- */
    :root {
      --bg-color: #f3f4f6;
      --text-main: #111827;
      --text-muted: #6b7280;
      --accent: #2563eb; 
      --card-bg: #ffffff;
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      /* No padding-top here because the overlay needs to cover full screen */
    }

    /* Navbar */
    .navbar {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      padding: 1rem 0;
    }
    .navbar-brand {
      color: var(--text-main) !important;
      font-weight: 800;
      letter-spacing: -0.05em;
      font-size: 1.5rem;
    }

    /* Hero */
    .hero { padding: 8rem 0 4rem 0; text-align: left; } /* Increased top padding */
    .hero h1 { font-size: clamp(2.5rem, 5vw, 4rem); font-weight: 800; letter-spacing: -0.03em; line-height: 1.1; margin-bottom: 1rem; }
    .hero p { font-size: 1.25rem; color: var(--text-muted); max-width: 600px; }

    /* Stats Cards */
    .stat-card {
      background: var(--card-bg); border: none; border-radius: 16px; padding: 2rem;
      box-shadow: var(--shadow); transition: transform 0.2s ease; height: 100%; position: relative; overflow: hidden;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-number { font-size: 3rem; font-weight: 700; color: var(--text-main); line-height: 1; margin-bottom: 0.5rem; }
    .stat-label { color: var(--text-muted); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.1em; font-weight: 600; }

    /* Submission Cards */
    .submission-card {
      background: var(--card-bg); border-radius: 16px; padding: 2rem; margin-bottom: 1.5rem;
      box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.03); transition: all 0.2s ease; animation: fadeIn 0.5s ease forwards;
    }
    .submission-card:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); border-color: var(--accent); }
    .sub-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #eee; flex-wrap: wrap; gap: 10px; }
    .sub-name { font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .sub-email { color: var(--accent); text-decoration: none; font-weight: 500; font-size: 0.95rem; }
    .sub-date { font-size: 0.85rem; color: #555; background: #e5e7eb; padding: 4px 12px; border-radius: 20px; font-weight: 600; }
    .sub-message { font-size: 1.1rem; line-height: 1.6; color: #374151; white-space: pre-wrap; }

    /* Search & Footer */
    .search-container { position: relative; max-width: 400px; }
    .search-input { border-radius: 50px; padding: 10px 20px 10px 40px; border: 1px solid #ddd; width: 100%; }
    .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #999; }
    .site-footer { margin-top: 5rem; padding: 3rem 0; border-top: 1px solid rgba(0,0,0,0.05); color: var(--text-muted); }
    .btn-custom { background-color: var(--text-main); color: white; border-radius: 50px; padding: 8px 24px; font-weight: 600; }
    .section-title { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); margin-bottom: 1.5rem; font-weight: 700; display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>

  <div id="loginOverlay">
      <div class="login-card">
          <div class="text-center mb-4">
              <div class="bg-primary text-white rounded p-2 d-inline-block mb-3"><i class="bi bi-shield-lock-fill fs-3"></i></div>
              <h3 class="fw-bold">Admin Access</h3>
              <p class="text-muted">Enter credentials to view data.</p>
          </div>
          <form id="loginForm">
              <div class="mb-3">
                  <label class="form-label small fw-bold">Email</label>
                  <input type="email" id="email" class="form-control" placeholder="admin@nexus.com" required>
              </div>
              <div class="mb-4">
                  <label class="form-label small fw-bold">Password</label>
                  <input type="password" id="password" class="form-control" placeholder="••••••••" required>
              </div>
              <button type="submit" class="btn btn-custom w-100 py-2">Unlock Dashboard</button>
              <div id="loginError" class="text-danger text-center mt-3 small"></div>
          </form>
          <div class="text-center mt-3">
              <a href="index.html" class="text-muted small text-decoration-none">← Back to Home</a>
          </div>
      </div>
  </div>


  <div id="dashboardContent">
      <nav class="navbar navbar-expand-lg fixed-top">
        <div class="container">
          <a class="navbar-brand" href="index.html">Smart Transit<span style="color:var(--accent)">.</span></a>
          <div class="d-flex align-items-center gap-3">
            <span class="badge bg-black text-white p-2 rounded-pill px-3">
                <i class="bi bi-shield-lock-fill me-1"></i> Admin
            </span>
            <button onclick="logout()" class="btn btn-outline-danger btn-sm rounded-pill px-3">Logout</button>
          </div>
        </div>
      </nav>

      <header class="hero">
        <div class="container">
          <div class="row">
            <div class="col-lg-8">
              <h1>Admin Dashboard <br> & Inquiries</h1>
              <p>Real-time overview of user feedback and system alerts.</p>
            </div>
          </div>
        </div>
      </header>

      <section class="container mb-5">
        <span class="section-title">Overview</span>
        <div class="row g-4">
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-number" id="msgCount">0</div>
              <div class="stat-label">Total Messages</div>
              <i class="bi bi-envelope position-absolute end-0 top-0 m-4 fs-1 text-muted opacity-25"></i>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card" style="border-bottom: 4px solid #10b981;">
              <div class="stat-number text-success">Active</div>
              <div class="stat-label">System Status</div>
              <i class="bi bi-hdd-network position-absolute end-0 top-0 m-4 fs-1 text-success opacity-25"></i>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-number">128</div>
              <div class="stat-label">Auto-Resolved</div>
              <i class="bi bi-robot position-absolute end-0 top-0 m-4 fs-1 text-muted opacity-25"></i>
            </div>
          </div>
        </div>
      </section>

      <main class="container my-5">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-end align-items-md-center mb-4 gap-3">
          <span class="section-title mb-0">Recent Submissions</span>
          
          <div class="d-flex gap-3 w-100 w-md-auto">
              <div class="search-container flex-grow-1">
                  <i class="bi bi-search search-icon"></i>
                  <input type="text" id="searchInput" class="search-input" placeholder="Search by name or email...">
              </div>
              <button id="refreshBtn" class="btn btn-custom btn-sm">
                <i class="bi bi-arrow-clockwise me-1"></i> Refresh
              </button>
          </div>
        </div>

        <div id="listArea">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="mt-3 text-muted">Awaiting Authentication...</p>
            </div>
        </div>
      </main>

      <footer class="site-footer text-center">
        <div class="container">
          <small>© 2025 Smart City Transport Project. All rights reserved.</small><br>
          <small class="text-muted">Authorized Personnel Only</small>
        </div>
      </footer>
  </div>


  <script>
    const API_URL = '/api';
    const listArea = document.getElementById('listArea');
    const refreshBtn = document.getElementById('refreshBtn');
    const searchInput = document.getElementById('searchInput');
    const msgCount = document.getElementById('msgCount');

    // --- AUTHENTICATION ---

    // 1. Check if already logged in on page load
    const savedToken = sessionStorage.getItem('nexus_token');
    if (savedToken) {
        document.body.classList.add('authenticated');
        loadSubmissions();
    }

    // 2. Login Form Handler
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const errDiv = document.getElementById('loginError');

        try {
            const res = await fetch(`${API_URL}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const data = await res.json();

            if (data.success) {
                sessionStorage.setItem('nexus_token', data.token); // Save token
                document.body.classList.add('authenticated'); // Unlock UI
                loadSubmissions(); // Load Data
            } else {
                errDiv.innerText = "Access Denied: " + (data.error || "Check credentials");
            }
        } catch (err) {
            errDiv.innerText = "Server not responding.";
        }
    });

    // 3. Logout
    function logout() {
        sessionStorage.removeItem('nexus_token');
        window.location.reload();
    }


    // --- DATA LOADING (PROTECTED) ---

    let allSubmissions = [];

    async function loadSubmissions() {
        refreshBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Loading...';
        const token = sessionStorage.getItem('nexus_token');
      
        try {
            const res = await fetch(`${API_URL}/contacts?limit=200`, { 
                headers: { 'Authorization': token }, // MUST SEND TOKEN
                cache: 'no-store' 
            });
            
            if (res.status === 401) {
                logout(); // Kick user out if token invalid
                return;
            }

            const json = await res.json();
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise me-1"></i> Refresh';

            if (!json.success) throw new Error(json.error || 'Failed to load');

            allSubmissions = json.data;
            msgCount.innerText = allSubmissions.length;
            renderList(allSubmissions);

        } catch (err) {
            refreshBtn.innerText = 'Retry';
            listArea.innerHTML = `<div class="alert alert-danger text-center">Connection Error</div>`;
        }
    }

    function renderList(data) {
        if (!data.length) {
            listArea.innerHTML = `<div class="p-5 text-center text-muted border rounded bg-white">No submissions found.</div>`;
            return;
        }

        const html = data.map(r => {
            let dateStr = "Just now";
            if (r.created_at) {
                const d = new Date(r.created_at);
                dateStr = d.toLocaleDateString() + ' • ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            }

            return `
              <div class="submission-card">
                <div class="sub-header">
                  <div>
                    <div class="sub-name">
                        <i class="bi bi-person-circle text-secondary"></i> ${escapeHtml(r.name)}
                    </div>
                    <div class="ms-4"><a href="#" class="sub-email">${escapeHtml(r.email)}</a></div>
                  </div>
                  <div class="sub-date">${dateStr}</div>
                </div>
                <p class="sub-message">${escapeHtml(r.message)}</p>
              </div>
            `;
        }).join('');
        
        listArea.innerHTML = html;
    }

    // Filter Logic
    searchInput.addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allSubmissions.filter(item => 
            (item.name && item.name.toLowerCase().includes(term)) || 
            (item.email && item.email.toLowerCase().includes(term))
        );
        renderList(filtered);
    });

    function escapeHtml(s) {
        if (!s) return '';
        return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    refreshBtn.addEventListener('click', loadSubmissions);
  </script>
</body>
</html>